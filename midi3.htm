<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MIDI Plucked-String Controller (No Canvas)</title>
  <style>
    body { margin: 0; font-family: sans-serif; padding-top: 3.5em; }
    header {
      position: fixed; top: 0; left: 0; right: 0;
      background: #333; color: #fff;
      padding: 0.5em 1em; z-index: 1000;
      display: flex; flex-wrap: wrap; align-items: center;
    }
    header > * { margin-right: 1em; }
    select, button, label {
      background: #555; color: #fff;
      border: none; padding: 0.3em;
      border-radius: 4px; font-size: 0.9em;
    }
    #toggleBtn {
      border-radius: 50%;
      width: 2.5em; height: 2.5em;
      font-size: 1.2em;
    }
    #perfArea { margin-top: 3.5em; }
    .keyboard {
      display: flex;
      user-select: none;
      touch-action: none;
    }
    .key {
      flex: 1;
      height: 50vh;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1em;
      border: 1px solid #000;
      box-sizing: border-box;
    }
    #configArea { padding: 1em; }
  </style>
</head>
<body>
  <header>
    <button id="toggleBtn" aria-label="Toggle settings">‚öôÔ∏è</button>

    <label for="midiOutSelect">MIDI Output:</label>
    <select id="midiOutSelect"></select>

    <label for="channelSelect">Channel:</label>
    <select id="channelSelect">
      <option value="0">1</option><option value="1">2</option>
      <option value="2">3</option><option value="3">4</option>
      <option value="4">5</option><option value="5">6</option>
      <option value="6">7</option><option value="7">8</option>
      <option value="8">9</option><option value="9">10</option>
      <option value="10">11</option><option value="11">12</option>
      <option value="12">13</option><option value="13">14</option>
      <option value="14">15</option><option value="15">16</option>
    </select>

    <label for="programSelect">Program:</label>
    <select id="programSelect"></select>

    <label><input type="checkbox" id="noteOffToggle" checked>
      Send Note-Off on release
    </label>

    <label for="layoutSelect">Layout:</label>
    <select id="layoutSelect"></select>

    <label for="baseNoteSelect">Base Note:</label>
    <select id="baseNoteSelect"></select>
  </header>

  <div id="perfArea">
    <div id="keyboard" class="keyboard"></div>
  </div>

  <div id="configArea" hidden>
    <p>Settings here</p>
  </div>

  <script>
  // MIDI + UI setup
  const GM_PROGRAM_NAMES = [
    /* 128 GM names... as before */
    "Acoustic Grand Piano","Bright Acoustic Piano","Electric Grand Piano","Honky-tonk Piano",
    /* ... all the way to ... */ "Gunshot"
  ];
  const NOTE_NAMES = ["C","C‚ôØ/D‚ô≠","D","D‚ôØ/E‚ô≠","E","F","F‚ôØ/G‚ô≠","G","G‚ôØ/A‚ô≠","A","A‚ôØ/B‚ô≠","B"];
  const KEYBOARD_LAYOUTS = {
    pentatonic: [48,50,52,55,57,60,62,64,67,69,72,74,76,79,81,84],
    /* ... other scales ... */
    min7:      [48,51,55,58,60,63,67,70,72,75,79,82,84]
  };
  const NOTE_COLORS = {
    0:'#D62828',1:'#E76F51',2:'#F4A261',3:'#E9C46A',
    4:'#A8DADC',5:'#2A9D8F',6:'#43AA8B',7:'#577590',
    8:'#3A0CA3',9:'#7209B7',10:'#F72585',11:'#B5179E'
  };

  let midiAccess, currentOutput;
  const midiOutSelect  = document.getElementById('midiOutSelect');
  const channelSelect  = document.getElementById('channelSelect');
  const programSelect  = document.getElementById('programSelect');
  const noteOffToggle  = document.getElementById('noteOffToggle');
  const layoutSelect   = document.getElementById('layoutSelect');
  const baseNoteSelect = document.getElementById('baseNoteSelect');
  const toggleBtn      = document.getElementById('toggleBtn');
  const perfArea       = document.getElementById('perfArea');
  const configArea     = document.getElementById('configArea');
  const keyboard       = document.getElementById('keyboard');
  let currentLayout = [], lastChannel = 0;

  // populate program
  GM_PROGRAM_NAMES.forEach((name,i) => {
    const o = document.createElement('option');
    o.value = i;
    o.textContent = `${i+1} ‚Äì ${name}`;
    programSelect.appendChild(o);
  });

  // populate layouts & base notes
  Object.keys(KEYBOARD_LAYOUTS).forEach(name => {
    const o = document.createElement('option');
    o.value = name; o.textContent = name;
    layoutSelect.appendChild(o);
  });
  NOTE_NAMES.forEach((n,i) => {
    const o = document.createElement('option');
    o.value = i; o.textContent = n;
    baseNoteSelect.appendChild(o);
  });

  // build keyboard keys
  function updateLayout() {
    const base = +baseNoteSelect.value;
    currentLayout = KEYBOARD_LAYOUTS[layoutSelect.value]
                      .map(n => n + base);
    renderKeys();
  }
  function renderKeys() {
    keyboard.innerHTML = '';
    currentLayout.forEach(n => {
      const key = document.createElement('div');
      key.className = 'key';
      key.dataset.note = n;
      key.style.background = NOTE_COLORS[n % 12] || '#ccc';
      key.textContent = NOTE_NAMES[n % 12];
      keyboard.appendChild(key);
    });
  }

  // MIDI init & handlers
  navigator.requestMIDIAccess().then(ma => {
    midiAccess = ma;
    // populate outputs
    for (let o of midiAccess.outputs.values()) {
      let opt = document.createElement('option');
      opt.value = o.id; opt.textContent = o.name;
      midiOutSelect.appendChild(opt);
    }
    midiOutSelect.selectedIndex = 0;
    currentOutput = midiAccess.outputs.get(midiOutSelect.value);

    // when output changes
    midiOutSelect.onchange = () => {
      currentOutput = midiAccess.outputs.get(midiOutSelect.value);
      dispatchProgramChange();
      sendAllNotesOff(lastChannel);
    };

    // program change
    programSelect.onchange = dispatchProgramChange;
    function dispatchProgramChange() {
      const prog = +programSelect.value;
      const chan = +channelSelect.value;
      currentOutput.send([0xC0 | chan, prog]);
    }

    // channel change
    channelSelect.onchange = () => {
      const newChan = +channelSelect.value;
      sendAllNotesOff(lastChannel);
      dispatchProgramChange();
      lastChannel = newChan;
    };

    // note-off toggle: clear when re-enabled
    noteOffToggle.onchange = () => {
      if (noteOffToggle.checked) {
        sendAllNotesOff(+channelSelect.value);
      }
    };
  }).catch(_=>{
    alert('MIDI not supported');
  });

  function sendAllNotesOff(chan) {
    currentOutput?.send([0xB0 | chan, 123, 0]);
  }

  function sendNoteOn(note, vel, chan) {
    currentOutput?.send([0x90 | chan, note, vel]);
  }
  function sendNoteOff(note, chan) {
    currentOutput?.send([0x80 | chan, note, 0]);
  }

  // pointer-based strumming with multi-touch
  const active = {};  // pointerId ‚Üí current note
  keyboard.addEventListener('pointerdown', e => {
    e.preventDefault();
    keyboard.setPointerCapture(e.pointerId);
    handlePointer(e);
  });
  keyboard.addEventListener('pointermove', e => {
    if (!(e.pointerId in active)) return;
    handlePointer(e);
  });
  keyboard.addEventListener('pointerup', e => {
    releasePointer(e);
  });
  keyboard.addEventListener('pointercancel', e => {
    releasePointer(e);
  });

  function handlePointer(e) {
    const rect = keyboard.getBoundingClientRect();
    const x = e.clientX, y = e.clientY;
    const idx = Math.floor((x - rect.left) / (rect.width / currentLayout.length));
    if (idx < 0 || idx >= currentLayout.length) return;
    const note = currentLayout[idx];
    const py = Math.max(0, Math.min(1, 1 - (y - rect.top)/rect.height));
    const vel = Math.round(py * 127);
    const prev = active[e.pointerId];
    if (prev !== note) {
      if (prev !== undefined) {
        if (noteOffToggle.checked) sendNoteOff(prev, +channelSelect.value);
      }
      sendNoteOn(note, vel, +channelSelect.value);
      active[e.pointerId] = note;
    }
  }

  function releasePointer(e) {
    const note = active[e.pointerId];
    delete active[e.pointerId];
    if (noteOffToggle.checked && note != null) {
      sendNoteOff(note, +channelSelect.value);
    }
    keyboard.releasePointerCapture(e.pointerId);
  }

  // UI toggle
  toggleBtn.addEventListener('click', () => {
    configArea.hidden = !configArea.hidden;
    perfArea.hidden = !perfArea.hidden;
    toggleBtn.textContent = configArea.hidden ? '‚öôÔ∏è' : 'üéπ';
  });

  // init
  layoutSelect.value   = Object.keys(KEYBOARD_LAYOUTS)[0];
  baseNoteSelect.value = '0';
  updateLayout();
  window.addEventListener('resize', renderKeys);
  </script>
</body>
</html>
